<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Block Calendar</title>
  <link href="https://fonts.googleapis.com/css2?family=Cabinet+Grotesk:wght@400;700;800;900
        &family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
        rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>* { box-sizing: border-box; margin: 0; padding: 0; } body { overflow: hidden; }</style>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase setup + Google Sign-In -->
  <script type="module">
    import { initializeApp }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    const firebaseConfig = {
      apiKey:            "AIzaSyCGaRGW8ke54K9CasAtFI5rTyLXQnO0OVc",
      authDomain:        "my-block-calendar.firebaseapp.com",
      projectId:         "my-block-calendar",
      storageBucket:     "my-block-calendar.firebasestorage.app",
      messagingSenderId: "347659580635",
      appId:             "1:347659580635:web:e985ddb31a9a83e737c8fe"
    };

    const app      = initializeApp(firebaseConfig);
    const db       = getFirestore(app);
    const auth     = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Expose to the React app
    window.__fb = { db, auth, provider, collection, doc,
                    setDoc, deleteDoc, onSnapshot,
                    signInWithPopup, onAuthStateChanged };
  </script>

  <!-- React app -->
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useCallback, useRef } = React;
    const { db, auth, provider, collection, doc, setDoc,
            deleteDoc, onSnapshot, signInWithPopup,
            onAuthStateChanged } = window.__fb;

    // ‚îÄ‚îÄ GOOGLE SIGN-IN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function SignInScreen() {
      const [loading, setLoading] = React.useState(false);
      const [error,   setError]   = React.useState('');
      const signIn = async () => {
        setLoading(true); setError('');
        try { await signInWithPopup(auth, provider); }
        catch(e) { setError('Sign-in cancelled or failed. Try again.');
                   setLoading(false); }
      };
      return (
        <div style={{display:'flex',flexDirection:'column',alignItems:'center',
                     justifyContent:'center',height:'100vh',background:'#f5f2eb'}}>
          <div style={{fontFamily:'Cabinet Grotesk,sans-serif',fontWeight:900,
                       fontSize:'2.5rem',color:'#e8380d',marginBottom:8}}>BLOCKS</div>
          <div style={{fontSize:'.9rem',color:'#8a8070',marginBottom:32}}>
            Your personal block calendar</div>
          <button onClick={signIn} disabled={loading}
            style={{padding:'14px 28px',background:'#1a1714',color:'#fff',border:'none',
                    borderRadius:10,fontFamily:'Cabinet Grotesk,sans-serif',
                    fontWeight:800,fontSize:'1rem',cursor:'pointer'}}>
            {loading ? 'Signing in...' : 'Sign in with Google'}
          </button>
          {error && <div style={{marginTop:12,color:'#e8380d',fontSize:'.8rem'}}>
            {error}</div>}
        </div>
      );
    }

    // ‚îÄ‚îÄ AUTH WRAPPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function AuthWrapper() {
  const [user, setUser] = React.useState(undefined);
  const [denied, setDenied] = React.useState(false);

  React.useEffect(() => {
    return onAuthStateChanged(auth, async (u) => {
      if (u && u.email !== 'joncherry@gmail.com') {
        setDenied(true);
        await auth.signOut();
        setUser(null);
      } else {
        setDenied(false);
        setUser(u || null);
      }
    });
  }, []);

  if (user === undefined) return (
    <div style={{display:'flex',alignItems:'center',justifyContent:'center',
                 height:'100vh',background:'#f5f2eb',
                 fontFamily:'Cabinet Grotesk,sans-serif',color:'#8a8070'}}>
      Loading‚Ä¶
    </div>
  );
  if (denied) return (
    <div style={{display:'flex',flexDirection:'column',alignItems:'center',
                 justifyContent:'center',height:'100vh',background:'#f5f2eb'}}>
      <div style={{fontFamily:'Cabinet Grotesk,sans-serif',fontWeight:900,
                   fontSize:'2.5rem',color:'#e8380d',marginBottom:8}}>BLOCKS</div>
      <div style={{fontSize:'.9rem',color:'#8a8070'}}>This calendar is private.</div>
    </div>
  );
  if (!user) return <SignInScreen />;
  return <App userId={user.uid} userEmail={user.email} />;
}

    // ‚îÄ‚îÄ PASTE YOUR block-calendar.jsx CODE HERE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ DEFAULT CATEGORIES (user can add/edit/delete) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_CATS = {
  work:    { label:"Work",    icon:"üíº", color:"#e8380d", bg:"#fde8e3", text:"#6b1505" },
  home:    { label:"Home",    icon:"üè†", color:"#0ea66b", bg:"#dff5ec", text:"#084a2e" },
  family:  { label:"Family",  icon:"‚ù§Ô∏è", color:"#c44bec", bg:"#f7e3fd", text:"#5a0e74" },
  fitness: { label:"Fitness", icon:"üèãÔ∏è", color:"#f5a800", bg:"#fff5d6", text:"#5c3d00" },
  reno:    { label:"Reno",    icon:"üî®", color:"#1a7fe8", bg:"#e3f0fd", text:"#0a3566" },
  other:   { label:"Other",   icon:"‚ú®", color:"#e8680d", bg:"#fdeee3", text:"#6b2a05" },
};

// Derive readable text color from hex background
function textForBg(hex) {
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return (r*0.299+g*0.587+b*0.114)>140 ? "#1a1714" : "#ffffff";
}
function lighten(hex, amt=0.88) {
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  const mix=(c)=>Math.round(c+(255-c)*amt);
  return `#${mix(r).toString(16).padStart(2,"0")}${mix(g).toString(16).padStart(2,"0")}${mix(b).toString(16).padStart(2,"0")}`;
}
function buildCat(label, icon, color) {
  const bg = lighten(color, 0.85);
  return { label, icon, color, bg, text: textForBg(bg) };
}

const PALETTE = ["#e8380d","#0ea66b","#c44bec","#f5a800","#1a7fe8","#e8680d","#14b8a6","#f43f5e","#8b5cf6","#ec4899","#84cc16","#06b6d4","#f97316","#6366f1"];
const ICONS   = ["üíº","üè†","‚ù§Ô∏è","üèãÔ∏è","üî®","‚ú®","üìö","üéµ","üßò","üéØ","üåø","üêæ","üç≥","üöó","üíª","üé®","üèÉ","üõí","üì±","üßπ"];

const DAYS_SHORT = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const DAYS_FULL  = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const MONTHS_S   = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const MONTHS_F   = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const HS=6, HE=23, HH=58;

function uid()    { return Math.random().toString(36).slice(2,9); }
function today0() { const d=new Date(); d.setHours(0,0,0,0); return d; }
function addDays(d,n) { const r=new Date(d); r.setDate(r.getDate()+n); return r; }
function sameDay(a,b) { return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }
function isToday(d)   { return sameDay(d,new Date()); }
function monday(d)    { const r=new Date(d),w=r.getDay(); r.setDate(r.getDate()-(w===0?6:w-1)); r.setHours(0,0,0,0); return r; }
function t2m(t)  { const [h,m]=t.split(":").map(Number); return h*60+m; }
function fmtDate(d)   { return d.toISOString().split("T")[0]; }

function occursOn(ev,d) {
  const evD=new Date(ev.date+"T00:00:00");
  if(ev.repeat==="none") return sameDay(evD,d);
  if(d<evD) return false;
  const diff=Math.round((d-evD)/86400000);
  if(ev.repeat==="daily")    return true;
  if(ev.repeat==="weekly")   return diff%7===0;
  if(ev.repeat==="biweekly") return diff%14===0;
  if(ev.repeat==="monthly")  return d.getDate()===evD.getDate();
  return false;
}

// ‚îÄ‚îÄ‚îÄ GUTTER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hourHits(evs, hr, cats) {
  const res=[];
  for(const ev of evs) {
    if(!cats[ev.cat]) continue;
    const sm=t2m(ev.start), em=t2m(ev.end);
    const overlap=Math.min(em,(hr+1)*60)-Math.max(sm,hr*60);
    if(overlap>0) res.push({ev, color:cats[ev.cat].color, weight:overlap});
  }
  return res;
}
function gutterBg(hits) {
  if(!hits.length) return "#f5f2eb";
  if(hits.length===1) return hits[0].color+"22";
  const total=hits.reduce((s,h)=>s+h.weight,0);
  let pct=0; const stops=[];
  hits.forEach(({color,weight})=>{
    const s=Math.round((pct/total)*100); pct+=weight;
    const e=Math.round((pct/total)*100);
    stops.push(`${color}33 ${s}%`,`${color}33 ${e}%`);
  });
  return `linear-gradient(to bottom,${stops.join(",")})`;
}
function dominantHit(hits) { return hits.reduce((a,b)=>b.weight>a.weight?b:a, hits[0]||null); }

// ‚îÄ‚îÄ‚îÄ SEED EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function seedEvents() {
  const td=today0(), f=fmtDate, w=monday(td), wed=addDays(w,2), fri=addDays(w,4), sat=addDays(w,5);
  return [
    {id:"e1",title:"Deep Work",      cat:"work",   date:f(w),  start:"09:00",end:"11:00",repeat:"weekly", notes:"No meetings",tasks:[{id:"t1",text:"Review backlog",done:false},{id:"t2",text:"Write spec",done:false}]},
    {id:"e2",title:"Team Standup",   cat:"work",   date:f(w),  start:"11:00",end:"11:30",repeat:"daily",  notes:"",           tasks:[{id:"t3",text:"Share blockers",done:false}]},
    {id:"e3",title:"House Cleaning", cat:"home",   date:f(wed),start:"10:00",end:"12:00",repeat:"weekly", notes:"",           tasks:[{id:"t4",text:"Kitchen",done:false},{id:"t5",text:"Bathrooms",done:false},{id:"t6",text:"Vacuum",done:false}]},
    {id:"e4",title:"Cook Dinner",    cat:"home",   date:f(td), start:"17:30",end:"18:30",repeat:"daily",  notes:"",           tasks:[]},
    {id:"e5",title:"Family Time",    cat:"family", date:f(fri),start:"18:30",end:"20:30",repeat:"weekly", notes:"Games/movie",tasks:[]},
    {id:"e6",title:"Morning Workout",cat:"fitness",date:f(td), start:"07:00",end:"08:00",repeat:"daily",  notes:"",           tasks:[{id:"t7",text:"Warmup",done:false},{id:"t8",text:"Circuit",done:false},{id:"t9",text:"Stretch",done:false}]},
    {id:"e7",title:"Bathroom Reno",  cat:"reno",   date:f(sat),start:"09:00",end:"13:00",repeat:"none",   notes:"Tile work",  tasks:[{id:"ta",text:"Get grout",done:false},{id:"tb",text:"Remove caulk",done:false}]},
  ];
}

// ‚îÄ‚îÄ‚îÄ CATEGORY EDITOR MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function CatModal({ cats, onSave, onClose }) {
  const [localCats, setLocalCats] = useState(
    Object.entries(cats).map(([k,v])=>({key:k,...v}))
  );
  const [editing, setEditing] = useState(null); // index or null
  const [newLabel,  setNewLabel]  = useState("");
  const [newIcon,   setNewIcon]   = useState("‚ú®");
  const [newColor,  setNewColor]  = useState("#8b5cf6");
  const [addMode,   setAddMode]   = useState(false);

  const startEdit = (i) => {
    const c=localCats[i];
    setEditing(i); setNewLabel(c.label); setNewIcon(c.icon); setNewColor(c.color); setAddMode(false);
  };
  const startAdd = () => {
    setEditing(null); setNewLabel(""); setNewIcon("‚ú®"); setNewColor("#8b5cf6"); setAddMode(true);
  };
  const applyEdit = () => {
    if(!newLabel.trim()) return;
    const built=buildCat(newLabel.trim(), newIcon, newColor);
    if(addMode) {
      setLocalCats(cs=>[...cs,{key:uid(),...built}]);
    } else {
      setLocalCats(cs=>cs.map((c,i)=>i===editing?{...c,...built,label:newLabel.trim(),icon:newIcon,color:newColor,bg:built.bg,text:built.text}:c));
    }
    setEditing(null); setAddMode(false);
  };
  const removeCat = (i) => setLocalCats(cs=>cs.filter((_,j)=>j!==i));

  const handleSave = () => {
    const out={};
    localCats.forEach(({key,...rest})=>{ out[key]=rest; });
    onSave(out);
  };

  const o={
    overlay:{position:"fixed",inset:0,background:"rgba(26,23,20,.7)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(4px)"},
    box:{background:"#fff",border:"2px solid #1a1714",borderRadius:14,width:520,maxWidth:"96vw",maxHeight:"90vh",overflowY:"auto",fontFamily:"'Instrument Sans',sans-serif"},
    head:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"18px 22px 14px",borderBottom:"1px solid #e0d9c8"},
    h2:{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.1rem",letterSpacing:"-.03em"},
    body:{padding:"16px 22px"},
    row:{display:"flex",alignItems:"center",gap:10,padding:"9px 0",borderBottom:"1px solid #f0ece0"},
    pill:{display:"flex",alignItems:"center",gap:7,padding:"5px 10px",borderRadius:20,fontSize:".78rem",fontWeight:700},
    editBox:{background:"#f5f2eb",borderRadius:10,padding:"14px",marginTop:10,display:"flex",flexDirection:"column",gap:10},
    label:{fontSize:".62rem",fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:"#8a8070",marginBottom:5,display:"block"},
    input:{width:"100%",background:"#fff",border:"1.5px solid #e0d9c8",borderRadius:7,padding:"8px 11px",fontFamily:"'Instrument Sans',sans-serif",fontSize:".88rem",outline:"none",color:"#1a1714"},
    iconGrid:{display:"flex",flexWrap:"wrap",gap:6,marginTop:4},
    iconBtn:(sel)=>({width:32,height:32,borderRadius:7,border:`2px solid ${sel?"#1a1714":"#e0d9c8"}`,background:sel?"#1a1714":"#f0ece0",cursor:"pointer",fontSize:"1rem",display:"flex",alignItems:"center",justifyContent:"center"}),
    colorRow:{display:"flex",gap:7,flexWrap:"wrap",marginTop:4},
    colorDot:(c,sel)=>({width:22,height:22,borderRadius:"50%",background:c,cursor:"pointer",border:`3px solid ${sel?"#1a1714":"transparent"}`,outline:sel?"2px solid #fff":"none",outlineOffset:-4}),
    foot:{display:"flex",gap:8,padding:"14px 22px 18px",borderTop:"1px solid #e0d9c8"},
    btnPri:{flex:1,background:"#1a1714",color:"#fff",border:"none",borderRadius:8,padding:"11px",fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".9rem",cursor:"pointer"},
    btnSec:{background:"#f0ece0",border:"1.5px solid #e0d9c8",color:"#8a8070",padding:"11px 14px",borderRadius:8,fontSize:".85rem",cursor:"pointer"},
    btnSm:{background:"none",border:"1.5px solid #e0d9c8",borderRadius:6,padding:"4px 9px",fontSize:".7rem",fontWeight:600,cursor:"pointer",color:"#8a8070"},
    btnDel:{background:"#fde8e3",border:"1.5px solid #e8380d",color:"#e8380d",borderRadius:6,padding:"4px 9px",fontSize:".7rem",fontWeight:600,cursor:"pointer"},
  };

  const isOpen = editing!==null||addMode;

  return (
    <div style={o.overlay} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={o.box}>
        <div style={o.head}>
          <h2 style={o.h2}>Manage Categories</h2>
          <button style={{...o.btnSm,border:"none"}} onClick={onClose}>‚úï</button>
        </div>
        <div style={o.body}>
          {localCats.map((c,i)=>(
            <div key={c.key} style={o.row}>
              <div style={{...o.pill,background:c.bg,color:c.text,border:`1.5px solid ${c.color}`}}>
                <span>{c.icon}</span><span>{c.label}</span>
              </div>
              <div style={{marginLeft:"auto",display:"flex",gap:6}}>
                <button style={o.btnSm} onClick={()=>startEdit(i)}>Edit</button>
                {localCats.length>1&&<button style={o.btnDel} onClick={()=>removeCat(i)}>Remove</button>}
              </div>
            </div>
          ))}

          {/* Editor panel */}
          {isOpen && (
            <div style={o.editBox}>
              <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".85rem",marginBottom:4}}>{addMode?"New Category":"Edit Category"}</div>
              <div>
                <label style={o.label}>Name</label>
                <input style={o.input} value={newLabel} onChange={e=>setNewLabel(e.target.value)} placeholder="e.g. Reading, Errands‚Ä¶" autoFocus />
              </div>
              <div>
                <label style={o.label}>Icon</label>
                <div style={o.iconGrid}>
                  {ICONS.map(ic=>(
                    <button key={ic} style={o.iconBtn(ic===newIcon)} onClick={()=>setNewIcon(ic)}>{ic}</button>
                  ))}
                </div>
              </div>
              <div>
                <label style={o.label}>Color</label>
                <div style={o.colorRow}>
                  {PALETTE.map(c=>(
                    <div key={c} style={o.colorDot(c,c===newColor)} onClick={()=>setNewColor(c)}></div>
                  ))}
                  <input type="color" value={newColor} onChange={e=>setNewColor(e.target.value)} style={{width:22,height:22,borderRadius:"50%",border:"none",padding:0,cursor:"pointer",background:"none"}} title="Custom color" />
                </div>
              </div>
              {/* Preview */}
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                <span style={{fontSize:".62rem",color:"#8a8070",fontWeight:600}}>Preview:</span>
                <div style={{...o.pill,...buildCat(newLabel||"Category",newIcon,newColor),border:`1.5px solid ${newColor}`}}>
                  <span>{newIcon}</span><span style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800}}>{newLabel||"Category"}</span>
                </div>
              </div>
              <div style={{display:"flex",gap:8,marginTop:4}}>
                <button style={o.btnSec} onClick={()=>{setEditing(null);setAddMode(false);}}>Cancel</button>
                <button style={o.btnPri} onClick={applyEdit}>{addMode?"Add Category":"Save Changes"}</button>
              </div>
            </div>
          )}

          {!isOpen && (
            <button onClick={startAdd} style={{display:"flex",alignItems:"center",gap:7,marginTop:12,padding:"9px 14px",background:"#f0ece0",border:"1.5px dashed #c0b8a8",borderRadius:8,cursor:"pointer",fontSize:".82rem",fontWeight:700,color:"#8a8070",width:"100%",justifyContent:"center"}}>
              Ôºã Add New Category
            </button>
          )}
        </div>
        <div style={o.foot}>
          <button style={o.btnSec} onClick={onClose}>Cancel</button>
          <button style={o.btnPri} onClick={handleSave}>Save All Changes</button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ BLOCK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function BlockModal({ev, date, cats, onSave, onDelete, onClose}) {
  const isEdit=!!ev;
  const firstCat=Object.keys(cats)[0]||"work";
  const [title,  setTitle]  = useState(ev?.title||"");
  const [cat,    setCat]    = useState(ev?.cat||firstCat);
  const [evDate, setEvDate] = useState(ev?.date||fmtDate(date||today0()));
  const [start,  setStart]  = useState(ev?.start||"09:00");
  const [end,    setEnd]    = useState(ev?.end||"10:00");
  const [repeat, setRepeat] = useState(ev?.repeat||"none");
  const [notes,  setNotes]  = useState(ev?.notes||"");
  const [tasks,  setTasks]  = useState(ev?.tasks?[...ev.tasks]:[]);
  const [newTask,setNewTask] = useState("");

  const addTask=()=>{ if(!newTask.trim())return; setTasks(t=>[...t,{id:uid(),text:newTask.trim(),done:false}]); setNewTask(""); };

  // If saved cat no longer exists in cats, fall back
  const activeCat = cats[cat] ? cat : firstCat;

  const s={
    overlay:{position:"fixed",inset:0,background:"rgba(26,23,20,.65)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(3px)"},
    modal:{background:"#fff",border:"2px solid #1a1714",borderRadius:14,width:490,maxWidth:"95vw",maxHeight:"90vh",overflowY:"auto"},
    head:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"18px 22px 14px",borderBottom:"1px solid #e0d9c8"},
    h2:{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.1rem",letterSpacing:"-.03em"},
    body:{padding:"16px 22px",display:"flex",flexDirection:"column",gap:13},
    lbl:{display:"block",fontSize:".62rem",fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:"#8a8070",marginBottom:6},
    inp:{width:"100%",background:"#f0ece0",border:"1.5px solid #e0d9c8",borderRadius:8,color:"#1a1714",padding:"9px 12px",fontFamily:"'Instrument Sans',sans-serif",fontSize:".88rem",outline:"none"},
    twoCol:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},
    foot:{display:"flex",gap:8,padding:"14px 22px 18px",borderTop:"1px solid #e0d9c8"},
    btnPri:{flex:1,background:"#1a1714",color:"#fff",border:"none",borderRadius:8,padding:12,fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".9rem",cursor:"pointer"},
    btnSec:{background:"#f0ece0",border:"1.5px solid #e0d9c8",color:"#8a8070",padding:"12px 16px",borderRadius:8,fontSize:".85rem",cursor:"pointer"},
    btnDel:{background:"#fde8e3",border:"1.5px solid #e8380d",color:"#e8380d",padding:"12px 14px",borderRadius:8,fontSize:".82rem",cursor:"pointer"},
  };

  return (
    <div style={s.overlay} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={s.modal}>
        <div style={s.head}>
          <h2 style={s.h2}>{isEdit?"Edit Block":"New Block"}</h2>
          <button style={{width:28,height:28,background:"#f0ece0",border:"none",borderRadius:5,cursor:"pointer",fontSize:"1rem",color:"#8a8070"}} onClick={onClose}>‚úï</button>
        </div>
        <div style={s.body}>
          <div><label style={s.lbl}>Title</label>
            <input style={s.inp} value={title} onChange={e=>setTitle(e.target.value)} placeholder="e.g. Deep work, Cook dinner‚Ä¶" autoFocus />
          </div>
          {/* Dynamic category picker */}
          <div><label style={s.lbl}>Category</label>
            <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:7}}>
              {Object.entries(cats).map(([k,v])=>(
                <div key={k} onClick={()=>setCat(k)} style={{display:"flex",alignItems:"center",gap:7,padding:"8px 9px",borderRadius:7,border:`${activeCat===k?2:1.5}px solid ${activeCat===k?v.color:"#e0d9c8"}`,cursor:"pointer",fontSize:".78rem",fontWeight:600,background:activeCat===k?v.bg:"#f0ece0",color:activeCat===k?v.text:"#1a1714",transition:"all .1s"}}>
                  <span style={{width:9,height:9,borderRadius:3,background:v.color,flexShrink:0}}></span>{v.icon} {v.label}
                </div>
              ))}
            </div>
          </div>
          <div><label style={s.lbl}>Date</label>
            <input style={s.inp} type="date" value={evDate} onChange={e=>setEvDate(e.target.value)} />
          </div>
          <div style={s.twoCol}>
            <div><label style={s.lbl}>Start</label><input style={s.inp} type="time" value={start} onChange={e=>setStart(e.target.value)} /></div>
            <div><label style={s.lbl}>End</label><input style={s.inp} type="time" value={end} onChange={e=>setEnd(e.target.value)} /></div>
          </div>
          <div><label style={s.lbl}>Repeat</label>
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {[["none","One-off"],["daily","Daily"],["weekly","Weekly"],["biweekly","Every 2 wks"],["monthly","Monthly"]].map(([k,l])=>(
                <div key={k} onClick={()=>setRepeat(k)} style={{padding:"5px 11px",borderRadius:20,border:`1.5px solid ${repeat===k?"#1a1714":"#e0d9c8"}`,background:repeat===k?"#1a1714":"#f0ece0",color:repeat===k?"#fff":"#1a1714",fontSize:".72rem",fontWeight:600,cursor:"pointer"}}>{l}</div>
              ))}
            </div>
          </div>
          <div><label style={s.lbl}>Tasks / Checklist</label>
            <div style={{border:"1.5px solid #e0d9c8",borderRadius:8,overflow:"hidden"}}>
              <div style={{maxHeight:130,overflowY:"auto"}}>
                {tasks.map((t,i)=>(
                  <div key={t.id} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 12px",borderBottom:"1px solid #e0d9c8"}}>
                    <input type="checkbox" checked={t.done} onChange={e=>setTasks(ts=>ts.map((x,j)=>j===i?{...x,done:e.target.checked}:x))} style={{width:13,height:13,accentColor:cats[activeCat]?.color||"#e8380d"}} />
                    <input style={{flex:1,background:"none",border:"none",outline:"none",fontFamily:"'Instrument Sans',sans-serif",fontSize:".85rem",color:"#1a1714"}} value={t.text} onChange={e=>setTasks(ts=>ts.map((x,j)=>j===i?{...x,text:e.target.value}:x))} placeholder="Task‚Ä¶" />
                    <button onClick={()=>setTasks(ts=>ts.filter((_,j)=>j!==i))} style={{background:"none",border:"none",cursor:"pointer",color:"#8a8070",fontSize:".85rem"}}>‚úï</button>
                  </div>
                ))}
              </div>
              <div style={{display:"flex",alignItems:"center",gap:8,padding:"8px 12px",background:"#f0ece0"}}>
                <input style={{flex:1,background:"none",border:"none",outline:"none",fontFamily:"'Instrument Sans',sans-serif",fontSize:".82rem",color:"#1a1714"}} value={newTask} onChange={e=>setNewTask(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addTask()} placeholder="Add task and press Enter‚Ä¶" />
                <button onClick={addTask} style={{background:"#1a1714",color:"#fff",border:"none",borderRadius:5,padding:"4px 10px",fontSize:".75rem",fontWeight:700,cursor:"pointer"}}>Ôºã</button>
              </div>
            </div>
          </div>
          <div><label style={s.lbl}>Notes</label>
            <textarea style={{...s.inp,resize:"vertical",minHeight:52}} value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Links, details‚Ä¶" rows={2} />
          </div>
        </div>
        <div style={s.foot}>
          <button style={s.btnSec} onClick={onClose}>Cancel</button>
          {isEdit&&<button style={s.btnDel} onClick={()=>onDelete(ev.id)}>Delete</button>}
          <button style={s.btnPri} onClick={()=>onSave({id:ev?.id||uid(),title,cat:activeCat,date:evDate,start,end,repeat,notes,tasks:tasks.filter(t=>t.text.trim())})}>Save Block</button>
        </div>
      </div>
    </div>
  );
}
    
// ‚îÄ‚îÄ‚îÄ NFC MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NfcModal({events, cats, taskStates, onClose}) {
  const [phone, setPhone] = useState("");

  const todayStr  = fmtDate(today0());
  const nowMin    = new Date().getHours()*60+new Date().getMinutes();
  const todayEvs  = events
    .filter(e=>cats[e.cat]&&occursOn(e,today0()))
    .sort((a,b)=>t2m(a.start)-t2m(b.start));

  const getTasksFor = (ev) => {
    const key=`${ev.id}_${todayStr}`, base=ev.tasks||[], saved=taskStates[key];
    if(!saved) return base;
    return base.map(t=>{ const s=saved.find(x=>x.id===t.id); return s?{...t,done:s.done}:t; });
  };

  const remaining = todayEvs
    .filter(ev=>t2m(ev.end)>nowMin)
    .map(ev=>({ ev, tasks:getTasksFor(ev).filter(t=>!t.done) }));

  const totalRemTasks = remaining.reduce((s,r)=>s+r.tasks.length,0);

  const now = new Date();
  const plainText = [
    `üìÖ Remaining today ‚Äî ${DAYS_SHORT[now.getDay()]} ${MONTHS_S[now.getMonth()]} ${now.getDate()}`,
    ``,
    ...remaining.map(({ev,tasks})=>[
      `${cats[ev.cat]?.icon||""} ${ev.title} ${ev.start}‚Äì${ev.end}`,
      ...tasks.map(t=>`  ‚òê ${t.text}`),
    ].join("\n")),
    remaining.length===0?"‚úÖ All done for today!":"",
  ].filter(Boolean).join("\n");

  // sms: link ‚Äî opens Messages pre-filled to the phone number with the body
  const smsHref = `sms:${phone.replace(/\D/g,"")}${phone?"&":"?"}body=${encodeURIComponent(plainText)}`;

  const o={
    overlay:{position:"fixed",inset:0,background:"rgba(26,23,20,.7)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(4px)"},
    box:{background:"#fff",border:"2px solid #1a1714",borderRadius:14,width:500,maxWidth:"96vw",maxHeight:"90vh",overflowY:"auto",fontFamily:"'Instrument Sans',sans-serif"},
    head:{padding:"18px 22px 14px",borderBottom:"1px solid #e0d9c8"},
    h2:{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.1rem",letterSpacing:"-.03em",marginBottom:4},
    sub:{fontSize:".72rem",color:"#8a8070",fontWeight:500},
    body:{padding:"16px 22px"},
    block:{marginBottom:12,padding:"10px 14px",borderRadius:10,borderLeft:"4px solid"},
    taskRow:{display:"flex",alignItems:"center",gap:8,fontSize:".78rem",marginTop:5,color:"#555"},
    urlBox:{background:"#f5f2eb",border:"1.5px solid #e0d9c8",borderRadius:8,padding:"10px 14px",fontSize:".72rem",fontFamily:"monospace",wordBreak:"break-all",color:"#555"},
    infoBox:{background:"#f0f9ff",border:"1.5px solid #bae6fd",borderRadius:8,padding:"12px 14px",fontSize:".78rem",color:"#0c4a6e",lineHeight:1.7},
    inp:{width:"100%",background:"#f5f2eb",border:"1.5px solid #e0d9c8",borderRadius:8,color:"#1a1714",padding:"9px 12px",fontFamily:"'Instrument Sans',sans-serif",fontSize:".88rem",outline:"none",marginTop:6},
    foot:{display:"flex",gap:8,padding:"14px 22px 18px",borderTop:"1px solid #e0d9c8"},
    btnPri:{flex:1,background:"#1a1714",color:"#fff",border:"none",borderRadius:8,padding:"11px",fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".88rem",cursor:"pointer",textDecoration:"none",display:"flex",alignItems:"center",justifyContent:"center",gap:6},
    btnSec:{background:"#f0ece0",border:"1.5px solid #e0d9c8",color:"#8a8070",padding:"11px 14px",borderRadius:8,fontSize:".85rem",cursor:"pointer"},
  };

  return (
    <div style={o.overlay} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={o.box}>
        <div style={o.head}>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
            <h2 style={o.h2}>üì° NFC Tag ‚Äî Daily Reminder</h2>
            <button style={{background:"none",border:"none",cursor:"pointer",fontSize:"1rem",color:"#8a8070"}} onClick={onClose}>‚úï</button>
          </div>
          <div style={o.sub}>Scan your NFC tag ‚Üí Shortcut runs ‚Üí iMessage sent to yourself with what's left today.</div>
        </div>

        <div style={o.body}>
          {/* Preview */}
          <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".85rem",marginBottom:10}}>
            Today's Remaining ‚Äî {remaining.length} block{remaining.length!==1?"s":""}, {totalRemTasks} task{totalRemTasks!==1?"s":""} left
          </div>
          {remaining.length===0&&(
            <div style={{padding:"14px",background:"#dff5ec",borderRadius:8,fontSize:".82rem",color:"#084a2e",fontWeight:600,marginBottom:12}}>‚úÖ Everything's done for today!</div>
          )}
          {remaining.map(({ev,tasks})=>{
            const c=cats[ev.cat]||{color:"#999",bg:"#eee",text:"#333",icon:"",label:ev.cat};
            return (
              <div key={ev.id} style={{...o.block,background:c.bg,borderColor:c.color,color:c.text}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:2}}>
                  <span style={{fontSize:".58rem",fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",opacity:.7}}>{c.label}</span>
                  <span style={{fontSize:".6rem",opacity:.6,marginLeft:"auto"}}>{ev.start}‚Äì{ev.end}</span>
                </div>
                <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".88rem"}}>{ev.title}</div>
                {tasks.map(t=>(
                  <div key={t.id} style={o.taskRow}>
                    <span style={{width:10,height:10,borderRadius:2,border:`1.5px solid ${c.color}`,display:"inline-block",flexShrink:0}}></span>
                    {t.text}
                  </div>
                ))}
                {tasks.length===0&&ev.tasks?.length>0&&<div style={{...o.taskRow,color:"#0ea66b",fontWeight:700}}>‚úì All tasks done</div>}
              </div>
            );
          })}

          {/* Message preview */}
          <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".82rem",marginTop:16,marginBottom:6}}>
            üí¨ Message Preview
          </div>
          <div style={{...o.urlBox,whiteSpace:"pre",maxHeight:120,overflowY:"auto",lineHeight:1.6,fontSize:".7rem"}}>{plainText}</div>

          {/* Phone number */}
          <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".82rem",marginTop:16,marginBottom:4}}>
            üì± Send to Your Number <span style={{fontSize:".65rem",color:"#8a8070",fontWeight:500}}>(optional ‚Äî leave blank to pick in Messages)</span>
          </div>
          <input style={o.inp} type="tel" value={phone} onChange={e=>setPhone(e.target.value)} placeholder="e.g. 7175551234" />

          {/* NFC Shortcut instructions */}
          <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".82rem",marginTop:18,marginBottom:8}}>
            üîß Set Up the NFC Shortcut (one-time)
          </div>
          <div style={o.infoBox}>
            <strong>Step 1 ‚Äî Create the Shortcut:</strong><br/>
            Open <strong>Shortcuts</strong> app ‚Üí tap <strong>Ôºã</strong> ‚Üí name it <em>"Daily Remaining"</em><br/><br/>
            <strong>Step 2 ‚Äî Add a Text action:</strong><br/>
            Search for <strong>Text</strong> action ‚Üí paste in the message preview above (or type a placeholder ‚Äî you'll update this when you scan).<br/><br/>
            <strong>Step 3 ‚Äî Add Send Message action:</strong><br/>
            Search <strong>"Send Message"</strong> ‚Üí set <em>Message</em> to the Text from Step 2 ‚Üí set <em>Recipients</em> to your own number ‚Üí turn <strong>Show When Run</strong> off so it fires silently.<br/><br/>
            <strong>Step 4 ‚Äî Add NFC trigger:</strong><br/>
            Go to <strong>Automation</strong> tab ‚Üí <strong>Ôºã New Automation</strong> ‚Üí <strong>NFC</strong> ‚Üí tap <em>Scan</em> and hold tag to phone ‚Üí select <em>"Daily Remaining"</em> shortcut ‚Üí disable <em>Ask Before Running</em>.<br/><br/>
            <strong>Step 5 ‚Äî Write the tag (optional):</strong><br/>
            Use <strong>NFC Tools</strong> app to also write your calendar URL to the tag so scanning opens the webpage too. Or keep it Shortcut-only.
          </div>

          <div style={{background:"#fff5d6",border:"1.5px solid #f5a800",borderRadius:8,padding:"10px 14px",fontSize:".75rem",color:"#5c3d00",marginTop:10,lineHeight:1.6}}>
            <strong>üí° Pro tip:</strong> Since Shortcuts can't dynamically read your calendar data at scan-time without extra setup, the cleanest flow is: scan tag ‚Üí Shortcut opens your deployed app URL at <code>?view=nfc</code> ‚Üí the page shows live remaining tasks ‚Üí tap the share sheet to send yourself a message. Or use the button below right now to pre-fill an iMessage manually.
          </div>
        </div>

        <div style={o.foot}>
          <button style={o.btnSec} onClick={onClose}>Close</button>
          <a href={smsHref} style={{...o.btnPri,textDecoration:"none"}}>
            üí¨ Open in Messages
          </a>
        </div>
      </div>
    </div>
  );
}
function NfcSummaryPage({events, cats, taskStates}) {
  const todayStr = fmtDate(today0());
  const nowMin   = new Date().getHours()*60+new Date().getMinutes();
  const todayEvs = events.filter(e=>cats[e.cat]&&occursOn(e,today0())).sort((a,b)=>t2m(a.start)-t2m(b.start));

  const getTasksFor=(ev)=>{
    const key=`${ev.id}_${todayStr}`, base=ev.tasks||[], saved=taskStates[key];
    if(!saved) return base;
    return base.map(t=>{const s=saved.find(x=>x.id===t.id);return s?{...t,done:s.done}:t;});
  };

  const remaining=todayEvs.filter(ev=>t2m(ev.end)>nowMin).map(ev=>({ev,tasks:getTasksFor(ev).filter(t=>!t.done)}));
  const past=todayEvs.filter(ev=>t2m(ev.end)<=nowMin);

  const now=new Date();

  return (
    <div style={{background:"#f5f2eb",minHeight:"100vh",fontFamily:"'Instrument Sans',sans-serif",color:"#1a1714"}}>
      {/* Header */}
      <div style={{background:"#1a1714",color:"#fff",padding:"20px 20px 16px"}}>
        <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.4rem",letterSpacing:"-.04em",display:"flex",alignItems:"center",gap:10}}>
          <span style={{width:10,height:10,borderRadius:"50%",background:"#e8380d",display:"inline-block"}}></span>BLOCKS
        </div>
        <div style={{fontSize:".78rem",opacity:.6,marginTop:4}}>{DAYS_FULL[now.getDay()]}, {MONTHS_F[now.getMonth()]} {now.getDate()} ¬∑ {now.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</div>
        <div style={{marginTop:12,fontSize:"1rem",fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800}}>{remaining.length} blocks remaining ¬∑ {remaining.reduce((s,r)=>s+r.tasks.length,0)} tasks to do</div>
      </div>

      <div style={{padding:"16px 16px"}}>
        {remaining.length===0&&(
          <div style={{background:"#dff5ec",border:"2px solid #0ea66b",borderRadius:12,padding:"20px",textAlign:"center",marginBottom:16}}>
            <div style={{fontSize:"2rem",marginBottom:8}}>‚úÖ</div>
            <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.1rem",color:"#084a2e"}}>All done for today!</div>
          </div>
        )}
        {remaining.map(({ev,tasks})=>{
          const c=cats[ev.cat]||{color:"#999",bg:"#eee",text:"#333",icon:"",label:ev.cat};
          const isNow=t2m(ev.start)<=nowMin;
          return (
            <div key={ev.id} style={{background:c.bg,border:`2px solid ${c.color}`,borderRadius:12,padding:"14px 16px",marginBottom:12,borderLeft:`6px solid ${c.color}`}}>
              <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
                <span style={{fontSize:".6rem",fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:c.color}}>{c.icon} {c.label}</span>
                {isNow&&<span style={{background:c.color,color:"#fff",fontSize:".55rem",fontWeight:700,padding:"2px 7px",borderRadius:20,letterSpacing:".06em",textTransform:"uppercase"}}>NOW</span>}
                <span style={{marginLeft:"auto",fontSize:".7rem",color:c.color,fontWeight:600,opacity:.8}}>{ev.start}‚Äì{ev.end}</span>
              </div>
              <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.05rem",letterSpacing:"-.02em",color:c.text,marginBottom:tasks.length?8:0}}>{ev.title}</div>
              {tasks.map(t=>(
                <div key={t.id} style={{display:"flex",alignItems:"center",gap:10,padding:"6px 0",borderTop:`1px solid ${c.color}22`,fontSize:".85rem",color:c.text}}>
                  <span style={{width:14,height:14,borderRadius:4,border:`2px solid ${c.color}`,display:"inline-block",flexShrink:0}}></span>
                  {t.text}
                </div>
              ))}
              {tasks.length===0&&ev.tasks?.length>0&&(
                <div style={{fontSize:".78rem",color:c.color,fontWeight:700}}>‚úì All tasks complete</div>
              )}
            </div>
          );
        })}

        {past.length>0&&(
          <div style={{marginTop:8}}>
            <div style={{fontSize:".65rem",fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:"#8a8070",marginBottom:8}}>Completed earlier</div>
            {past.map(ev=>{
              const c=cats[ev.cat]||{color:"#999",bg:"#eee",text:"#333",icon:"",label:ev.cat};
              return (
                <div key={ev.id} style={{background:"#f0ece0",borderRadius:8,padding:"9px 12px",marginBottom:6,display:"flex",alignItems:"center",gap:8,opacity:.6}}>
                  <span>{c.icon}</span>
                  <span style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:700,fontSize:".82rem",textDecoration:"line-through"}}>{ev.title}</span>
                  <span style={{marginLeft:"auto",fontSize:".65rem",color:"#8a8070"}}>{ev.start}‚Äì{ev.end}</span>
                </div>
              );
            })}
          </div>
        )}

        <div style={{textAlign:"center",marginTop:20,fontSize:".65rem",color:"#8a8070"}}>
          <a href={window.location.href.split("?")[0]} style={{color:"#1a1714",fontWeight:700}}>Open full calendar ‚Üí</a>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App({ userId, userEmail }) {
  const params = new URLSearchParams(window.location.search);
  const isNfcView = params.get("view")==="nfc";

  const [cats,       setCats]       = useState(DEFAULT_CATS);
  const [events,     setEvents]     = useState(seedEvents);
  const [view,       setView]       = useState("day");
  const [focusDate,  setFocusDate]  = useState(today0());
  const [hiddenCats, setHiddenCats] = useState(new Set());
  const [modal,      setModal]      = useState(null);
  const [catModal,   setCatModal]   = useState(false);
  const [nfcModal,   setNfcModal]   = useState(false);
  const [taskStates, setTaskStates] = useState({});
  const [now,        setNow]        = useState(new Date());

  useEffect(()=>{ const t=setInterval(()=>setNow(new Date()),30000); return ()=>clearInterval(t); },[]);

  useEffect(() => {
  if (!userId) return;
  return onSnapshot(
    collection(db, 'users', userId, 'events'),
    snap => {
      const evs = [];
      snap.forEach(d => evs.push(d.data()));
      setEvents(evs.length ? evs : seedEvents());
    }
  );
}, [userId]);

  const visibleEvs = useCallback((d)=>{
    return events.filter(e=>cats[e.cat]&&!hiddenCats.has(e.cat)&&occursOn(e,d)).sort((a,b)=>t2m(a.start)-t2m(b.start));
  },[events,cats,hiddenCats]);

  const getTasksFor=(ev,dateStr)=>{
    const key=`${ev.id}_${dateStr}`, base=ev.tasks||[], saved=taskStates[key];
    if(!saved) return base;
    return base.map(t=>{const s=saved.find(x=>x.id===t.id);return s?{...t,done:s.done}:t;});
  };
  const toggleTask=(evId,taskId,dateStr,done)=>{
    const ev=events.find(e=>e.id===evId); if(!ev) return;
    const tasks=getTasksFor(ev,dateStr).map(t=>t.id===taskId?{...t,done}:t);
    setTaskStates(ts=>({...ts,[`${evId}_${dateStr}`]:tasks}));
  };

  const saveCats=(newCats)=>{ setCats(newCats); setCatModal(false); };
  const saveEvent = async (ev) => {
  setEvents(evs => evs.find(e=>e.id===ev.id)
    ? evs.map(e=>e.id===ev.id?ev:e) : [...evs,ev]);
  await setDoc(doc(db,'users',userId,'events',ev.id), ev);
  setModal(null);
};
const deleteEvent = async (id) => {
  setEvents(evs=>evs.filter(e=>e.id!==id));
  await deleteDoc(doc(db,'users',userId,'events',id));
  setModal(null);
};
  const openNew=(date,hour=9)=>setModal({ev:null,date,hour});
  const openEdit=(ev)=>setModal({ev,date:null,hour:null});

  if(isNfcView) return <NfcSummaryPage events={events} cats={cats} taskStates={taskStates}/>;

  const ws=monday(focusDate);
  const weekDays=Array.from({length:7},(_,i)=>addDays(ws,i));
  const nowMin=now.getHours()*60+now.getMinutes();
  const todayStr=fmtDate(today0());
  const todayEvs=visibleEvs(today0());
  let totalTasks=0,doneTasks=0;
  todayEvs.forEach(ev=>{const t=getTasksFor(ev,todayStr);totalTasks+=t.length;doneTasks+=t.filter(x=>x.done).length;});
  const dayProg=Math.max(0,Math.min(100,((nowMin-HS*60)/((HE-HS)*60))*100));
  const activeNow=todayEvs.filter(e=>t2m(e.start)<=nowMin&&t2m(e.end)>nowMin);

  // ‚îÄ Gutter label renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const renderGutter=(evs,hr,isWeek=false)=>{
    const hits=hourHits(evs,hr,cats);
    const bg=gutterBg(hits);
    const dom=dominantHit(hits);
    const domCat=dom?cats[dom.ev.cat]:null;
    const borderRight=dom?`3px solid ${dom.color}`:"2px solid #1a1714";

    // unique cats active this hour
    const activeCats=[...new Map(hits.map(h=>[h.ev.cat,h])).values()];

    return (
      <div style={{
        height:HH, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center",
        padding:"2px 3px", fontSize:".55rem", fontWeight:700, letterSpacing:".04em", color:"#8a8070",
        borderRight, background:bg, position:"sticky", left:0, zIndex:5, transition:"background .3s, border-color .3s",
        overflow:"hidden", gap:1,
      }}>
        {/* Time */}
        <span style={{color:dom?dom.color:"#8a8070",fontWeight:800,fontSize:".6rem"}}>
          {hr===12?"12p":hr>12?`${hr-12}p`:`${hr}a`}
        </span>
        {/* Category labels ‚Äî always show abbreviated text name */}
        {activeCats.slice(0,isWeek?1:2).map(h=>{
          const c=cats[h.ev.cat];
          // Abbrev: up to 4 chars for week (tight), 5 for day
          const abbrev = c.label.slice(0, isWeek ? 4 : 5).toUpperCase();
          return (
            <div key={h.ev.cat} style={{lineHeight:1, marginTop:2, textAlign:"center"}}>
              <span style={{
                color: c.color,
                textTransform: "uppercase",
                letterSpacing: ".07em",
                fontSize: isWeek ? ".42rem" : ".46rem",
                fontWeight: 900,
                display: "block",
                whiteSpace: "nowrap",
                overflow: "hidden",
                maxWidth: HH - 6,
              }}>
                {abbrev}
              </span>
            </div>
          );
        })}
      </div>
    );
  };

  const sx={
    root:{display:"flex",flexDirection:"column",height:"100vh",background:"#f5f2eb",fontFamily:"'Instrument Sans',sans-serif",color:"#1a1714",overflow:"hidden"},
    topbar:{display:"flex",alignItems:"center",background:"#fff",borderBottom:"2px solid #1a1714",flexShrink:0,height:50},
    brand:{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1rem",letterSpacing:"-.04em",padding:"0 16px",borderRight:"2px solid #1a1714",height:"100%",display:"flex",alignItems:"center",gap:7},
    dateNav:{display:"flex",alignItems:"center",height:"100%",borderRight:"2px solid #1a1714"},
    navBtn:{width:38,height:"100%",background:"none",border:"none",cursor:"pointer",fontSize:"1.1rem",display:"flex",alignItems:"center",justifyContent:"center"},
    dateLbl:{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".9rem",letterSpacing:"-.02em",padding:"0 12px",minWidth:170,textAlign:"center"},
    todayBtn:{height:"100%",padding:"0 12px",background:"none",border:"none",borderLeft:"1px solid #e0d9c8",fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:700,fontSize:".68rem",letterSpacing:".07em",textTransform:"uppercase",color:"#8a8070",cursor:"pointer"},
    viewTabs:{display:"flex",height:"100%",borderRight:"2px solid #1a1714"},
    viewTab:(a)=>({height:"100%",padding:"0 12px",background:a?"#1a1714":"none",color:a?"#fff":"#8a8070",border:"none",borderRight:"1px solid #e0d9c8",fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:700,fontSize:".68rem",letterSpacing:".07em",textTransform:"uppercase",cursor:"pointer"}),
    iconBtn:{height:30,padding:"0 11px",background:"#f0ece0",border:"1.5px solid #e0d9c8",borderRadius:6,fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:700,fontSize:".68rem",letterSpacing:".04em",textTransform:"uppercase",color:"#1a1714",cursor:"pointer",display:"flex",alignItems:"center",gap:5,whiteSpace:"nowrap"},
    addBtn:{height:32,padding:"0 14px",background:"#1a1714",color:"#fff",border:"none",borderRadius:5,fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".8rem",cursor:"pointer"},
    // legend
    legendBar:{display:"flex",alignItems:"stretch",background:"#fff",borderBottom:"2px solid #1a1714",flexShrink:0,overflowX:"auto"},
    // glance
    glance:{width:210,flexShrink:0,background:"#fff",borderRight:"2px solid #1a1714",overflowY:"auto",display:"flex",flexDirection:"column"},
    statCell:{background:"#fff",padding:"9px 11px"},
    statNum:{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.3rem",letterSpacing:"-.04em",lineHeight:1},
    statLbl:{fontSize:".58rem",fontWeight:600,letterSpacing:".07em",textTransform:"uppercase",color:"#8a8070",marginTop:2},
    // day
    dayPanel:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},
    dayScroll:{flex:1,overflowY:"auto",overflowX:"hidden"},
    timeGrid:{display:"grid",gridTemplateColumns:`${HH}px 1fr`,position:"relative"},
    tCol:{height:HH,borderBottom:"1px solid #e0d9c8",position:"relative",cursor:"pointer"},
    // mini
    miniDay:(a,t)=>({display:"flex",alignItems:"center",gap:7,padding:"5px 7px",borderRadius:6,cursor:"pointer",background:a?"#1a1714":"transparent",color:a?"#fff":"#1a1714",border:`1.5px solid ${t&&!a?"#e8380d":"transparent"}`,marginBottom:2}),
  };

  const evBlockStyle=(ev,top,height)=>({
    position:"absolute",left:5,right:5,top,height,borderRadius:8,padding:"5px 9px",cursor:"pointer",
    background:cats[ev.cat]?.bg||"#eee",borderLeft:`4px solid ${cats[ev.cat]?.color||"#999"}`,
    border:`2px solid ${cats[ev.cat]?.color||"#999"}`,color:cats[ev.cat]?.text||"#333",overflow:"hidden",zIndex:2,
  });

  const renderTimeGrid=(d)=>{
    const dateStr=fmtDate(d), evs=visibleEvs(d), cols=[];
    for(let hr=HS;hr<HE;hr++){
      cols.push(<div key={`l${hr}`}>{renderGutter(evs,hr,false)}</div>);
      const evHere=evs.filter(ev=>Math.floor(t2m(ev.start)/60)===hr);
      cols.push(
        <div key={`c${hr}`} style={sx.tCol} onClick={()=>openNew(d,hr)}>
          {evHere.map(ev=>{
            const sm=t2m(ev.start),em=t2m(ev.end),dur=Math.max(em-sm,30);
            const top=((sm%60)/60)*HH, height=Math.max((dur/60)*HH-4,22);
            const tasks=getTasksFor(ev,dateStr);
            const pct=tasks.length?(tasks.filter(t=>t.done).length/tasks.length)*100:0;
            return (
              <div key={ev.id} style={evBlockStyle(ev,top,height)} onClick={e=>{e.stopPropagation();openEdit(ev);}}>
                <div style={{fontSize:".54rem",fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",opacity:.65,marginBottom:1}}>{cats[ev.cat]?.icon} {cats[ev.cat]?.label}{ev.repeat!=="none"?" ‚Üª":""}</div>
                <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".82rem",letterSpacing:"-.02em",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{ev.title}</div>
                {height>42&&<div style={{fontSize:".6rem",opacity:.6,marginTop:1}}>{ev.start}‚Äì{ev.end}</div>}
                {height>60&&tasks.length>0&&(
                  <div style={{marginTop:4}}>
                    {tasks.slice(0,Math.min(tasks.length,Math.floor((height-52)/15))).map(t=>(
                      <div key={t.id} style={{display:"flex",alignItems:"center",gap:4,fontSize:".62rem",marginBottom:1}} onClick={e=>e.stopPropagation()}>
                        <input type="checkbox" checked={t.done} onChange={e=>toggleTask(ev.id,t.id,dateStr,e.target.checked)} style={{width:10,height:10,accentColor:cats[ev.cat]?.color||"#e8380d"}} />
                        <span style={{textDecoration:t.done?"line-through":"none",opacity:t.done?.45:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{t.text}</span>
                      </div>
                    ))}
                    <div style={{height:3,background:"rgba(0,0,0,.08)",borderRadius:2,marginTop:3,overflow:"hidden"}}>
                      <div style={{width:`${pct}%`,height:"100%",background:"rgba(0,0,0,.25)",borderRadius:2}}></div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
          {isToday(d)&&now.getHours()===hr&&(
            <div style={{position:"absolute",left:0,right:0,top:`${(now.getMinutes()/60)*HH}px`,height:2,background:"#e8380d",zIndex:5,pointerEvents:"none"}}>
              <div style={{position:"absolute",left:-1,top:-4,width:10,height:10,borderRadius:"50%",background:"#e8380d"}}></div>
            </div>
          )}
        </div>
      );
    }
    return cols;
  };

  return (
    <div style={sx.root}>
      {/* TOPBAR */}
      <div style={sx.topbar}>
        <div style={sx.brand}><span style={{width:9,height:9,borderRadius:"50%",background:"#e8380d"}}></span>BLOCKS</div>
        <div style={sx.dateNav}>
          <button style={sx.navBtn} onClick={()=>setFocusDate(d=>view==="week"?addDays(monday(d),-7):addDays(d,-1))}>‚Äπ</button>
          <span style={sx.dateLbl}>{view==="day"?`${DAYS_SHORT[focusDate.getDay()]} ${MONTHS_S[focusDate.getMonth()]} ${focusDate.getDate()}`:`${MONTHS_S[ws.getMonth()]} ${ws.getDate()} ‚Äì ${MONTHS_S[addDays(ws,6).getMonth()]} ${addDays(ws,6).getDate()}`}</span>
          <button style={sx.navBtn} onClick={()=>setFocusDate(d=>view==="week"?addDays(monday(d),7):addDays(d,1))}>‚Ä∫</button>
        </div>
        <button style={sx.todayBtn} onClick={()=>setFocusDate(today0())}>Today</button>
        <div style={sx.viewTabs}>
          <button style={sx.viewTab(view==="day")} onClick={()=>setView("day")}>Day</button>
          <button style={sx.viewTab(view==="week")} onClick={()=>setView("week")}>Week</button>
        </div>
        <div style={{marginLeft:"auto",display:"flex",alignItems:"center",gap:7,paddingRight:12}}>
          <button style={sx.iconBtn} onClick={()=>setNfcModal(true)}>üì° NFC</button>
          <button style={sx.iconBtn} onClick={()=>setCatModal(true)}>‚öô Categories</button>
          <button style={sx.addBtn} onClick={()=>openNew(focusDate)}>Ôºã New Block</button>
        </div>
      </div>

      {/* LEGEND / FILTER BAR */}
      <div style={sx.legendBar}>
        <div style={{display:"flex",alignItems:"center",padding:"0 12px",fontSize:".6rem",fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"#8a8070",borderRight:"1px solid #e0d9c8",whiteSpace:"nowrap",flexShrink:0}}>
          Filter:
        </div>
        {Object.entries(cats).map(([k,v])=>{
          const hidden=hiddenCats.has(k);
          return (
            <div key={k} onClick={()=>setHiddenCats(prev=>{const n=new Set(prev);n.has(k)?n.delete(k):n.add(k);return n;})}
              style={{display:"flex",alignItems:"center",gap:7,padding:"6px 14px 6px 10px",fontSize:".7rem",fontWeight:700,letterSpacing:".04em",textTransform:"uppercase",cursor:"pointer",borderRight:"1px solid #e0d9c8",whiteSpace:"nowrap",userSelect:"none",opacity:hidden?.3:1,background:hidden?"transparent":v.bg+"99",transition:"all .15s"}}>
              <span style={{width:8,height:8,borderRadius:2,background:v.color}}></span>
              {v.icon} {v.label}
              {hidden&&<span style={{fontSize:".58rem",opacity:.7}}>‚úï</span>}
            </div>
          );
        })}
        {hiddenCats.size>0&&(
          <div onClick={()=>setHiddenCats(new Set())} style={{display:"flex",alignItems:"center",padding:"0 14px",fontSize:".65rem",fontWeight:700,color:"#e8380d",cursor:"pointer",whiteSpace:"nowrap",marginLeft:"auto",borderLeft:"1px solid #e0d9c8"}}>
            Show all
          </div>
        )}
      </div>

      {/* MAIN */}
      <div style={{flex:1,display:"flex",overflow:"hidden"}}>

        {/* TODAY GLANCE */}
        {view==="day"&&(
          <div style={sx.glance}>
            <div style={{padding:"13px 13px 9px",borderBottom:"1px solid #e0d9c8",flexShrink:0}}>
              <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:".9rem",letterSpacing:"-.02em"}}>Today at a Glance</div>
              <div style={{fontSize:".62rem",color:"#8a8070",fontWeight:600,marginTop:2}}>{DAYS_FULL[now.getDay()]}, {MONTHS_S[now.getMonth()]} {now.getDate()}</div>
            </div>
            <div style={{padding:"10px 13px",borderBottom:"1px solid #e0d9c8"}}>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:".6rem",fontWeight:700,letterSpacing:".05em",textTransform:"uppercase",color:"#8a8070",marginBottom:5}}>
                <span>Day progress</span><span>{Math.round(dayProg)}%</span>
              </div>
              <div style={{height:5,background:"#f0ece0",borderRadius:3,overflow:"hidden"}}>
                <div style={{width:`${dayProg}%`,height:"100%",borderRadius:3,background:activeNow.length?cats[activeNow[0].cat]?.color||"#e8380d":"#e8380d",transition:"width .4s"}}></div>
              </div>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1,background:"#e0d9c8",borderTop:"1px solid #e0d9c8",flexShrink:0}}>
              <div style={sx.statCell}><div style={sx.statNum}>{todayEvs.length}</div><div style={sx.statLbl}>Blocks</div></div>
              <div style={sx.statCell}><div style={sx.statNum}>{totalTasks>0?Math.round((doneTasks/totalTasks)*100)+"%":"‚Äî"}</div><div style={sx.statLbl}>Tasks done</div></div>
              <div style={sx.statCell}><div style={{...sx.statNum,color:"#e8380d"}}>{activeNow.length||"‚Äî"}</div><div style={sx.statLbl}>Right now</div></div>
              <div style={sx.statCell}><div style={sx.statNum}>{todayEvs.filter(e=>t2m(e.start)>nowMin).length}</div><div style={sx.statLbl}>Upcoming</div></div>
            </div>
            <div style={{flex:1,overflowY:"auto"}}>
              {todayEvs.length===0&&<div style={{padding:"14px 12px",fontSize:".75rem",color:"#8a8070",fontStyle:"italic"}}>No blocks today</div>}
              {todayEvs.map(ev=>{
                const sm=t2m(ev.start),em=t2m(ev.end);
                const isPast=em<=nowMin, isNow=sm<=nowMin&&em>nowMin;
                const tasks=getTasksFor(ev,todayStr);
                const c=cats[ev.cat]||{color:"#999",icon:"",label:ev.cat};
                return (
                  <div key={ev.id} style={{padding:"8px 12px",borderBottom:"1px solid #e0d9c8",cursor:"pointer",background:isNow?"#fff8f7":"#fff",borderLeft:isNow?`3px solid ${c.color}`:"3px solid transparent",opacity:isPast?.5:1}} onClick={()=>openEdit(ev)}>
                    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:2}}>
                      <span style={{width:7,height:7,borderRadius:2,background:c.color,flexShrink:0}}></span>
                      <span style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".75rem",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}>{ev.title}</span>
                      {ev.repeat!=="none"&&<span style={{fontSize:".55rem",opacity:.4}}>‚Üª</span>}
                    </div>
                    <div style={{fontSize:".6rem",color:"#8a8070",fontWeight:500}}>{ev.start}‚Äì{ev.end}</div>
                    {tasks.length>0&&(
                      <div style={{marginTop:4}} onClick={e=>e.stopPropagation()}>
                        {tasks.slice(0,3).map(t=>(
                          <label key={t.id} style={{display:"flex",alignItems:"center",gap:5,fontSize:".62rem",color:"#8a8070",cursor:"pointer",marginTop:2}}>
                            <input type="checkbox" checked={t.done} onChange={e=>toggleTask(ev.id,t.id,todayStr,e.target.checked)} style={{width:10,height:10,accentColor:c.color}} />
                            <span style={{textDecoration:t.done?"line-through":"none"}}>{t.text}</span>
                          </label>
                        ))}
                        {tasks.length>3&&<div style={{fontSize:".58rem",color:"#8a8070",marginTop:2}}>+{tasks.length-3} more‚Ä¶</div>}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            {/* Mini week */}
            <div style={{padding:"11px 10px",borderTop:"1px solid #e0d9c8",flexShrink:0}}>
              <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:800,fontSize:".58rem",letterSpacing:".1em",textTransform:"uppercase",color:"#8a8070",marginBottom:6,paddingBottom:6,borderBottom:"1px solid #e0d9c8"}}>This Week</div>
              {weekDays.map(d=>{
                const evs=visibleEvs(d);
                return (
                  <div key={fmtDate(d)} style={sx.miniDay(sameDay(d,focusDate),isToday(d))} onClick={()=>setFocusDate(new Date(d))}>
                    <div style={{fontSize:".6rem",fontWeight:700,letterSpacing:".05em",textTransform:"uppercase",opacity:.55,width:22}}>{DAYS_SHORT[d.getDay()]}</div>
                    <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:".95rem",letterSpacing:"-.03em",width:20}}>{d.getDate()}</div>
                    <div style={{display:"flex",gap:2,flexWrap:"wrap",flex:1}}>
                      {[...new Set(evs.map(e=>e.cat))].map(c=>(
                        <span key={c} style={{width:6,height:6,borderRadius:2,background:sameDay(d,focusDate)?"rgba(255,255,255,.7)":cats[c]?.color||"#999"}}></span>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* DAY VIEW */}
        {view==="day"&&(
          <div style={sx.dayPanel}>
            <div style={{padding:"13px 18px 9px",background:"#fff",borderBottom:"2px solid #1a1714",flexShrink:0}}>
              <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.6rem",letterSpacing:"-.04em",lineHeight:1}}>
                <span style={{color:visibleEvs(focusDate).length?cats[visibleEvs(focusDate)[0].cat]?.color||"#1a1714":"#1a1714"}}>{DAYS_FULL[focusDate.getDay()]}</span>
                {", "}{MONTHS_F[focusDate.getMonth()]} {focusDate.getDate()}, {focusDate.getFullYear()}
              </div>
              <div style={{fontSize:".68rem",color:"#8a8070",fontWeight:600,marginTop:3}}>{visibleEvs(focusDate).length} block{visibleEvs(focusDate).length!==1?"s":""} scheduled ¬∑ Click any time slot to add</div>
            </div>
            <div style={sx.dayScroll}>
              <div style={sx.timeGrid}>{renderTimeGrid(focusDate)}</div>
            </div>
          </div>
        )}

        {/* WEEK VIEW */}
        {view==="week"&&(
          <div style={{flex:1,overflow:"auto"}}>
            <div style={{display:"grid",gridTemplateColumns:`${HH}px repeat(7,1fr)`,minWidth:700}}>
              <div style={{background:"#f5f2eb",borderRight:"2px solid #1a1714",borderBottom:"1px solid #e0d9c8",position:"sticky",top:0,zIndex:10,height:48}}></div>
              {weekDays.map(d=>(
                <div key={fmtDate(d)} onClick={()=>{setFocusDate(new Date(d));setView("day");}}
                  style={{borderBottom:isToday(d)?"3px solid #e8380d":"1px solid #e0d9c8",borderRight:"1px solid #e0d9c8",padding:"8px 4px",textAlign:"center",position:"sticky",top:0,zIndex:9,background:"#fff",cursor:"pointer",height:48}}>
                  <div style={{fontSize:".6rem",fontWeight:700,textTransform:"uppercase",letterSpacing:".07em",color:"#8a8070"}}>{DAYS_SHORT[d.getDay()]}</div>
                  <div style={{fontFamily:"'Cabinet Grotesk',sans-serif",fontWeight:900,fontSize:"1.3rem",letterSpacing:"-.04em",lineHeight:1,marginTop:1,color:isToday(d)?"#e8380d":"#1a1714"}}>{d.getDate()}</div>
                </div>
              ))}
              {Array.from({length:HE-HS},(_,hi)=>hi+HS).map(hr=>(
                <>
                  <div key={`l${hr}`} style={{position:"sticky",left:0,zIndex:5}}>
                    {renderGutter(weekDays.flatMap(d=>visibleEvs(d)),hr,true)}
                  </div>
                  {weekDays.map(d=>{
                    const evHere=visibleEvs(d).filter(ev=>Math.floor(t2m(ev.start)/60)===hr);
                    return (
                      <div key={fmtDate(d)+hr} style={{height:HH,borderRight:"1px solid #e0d9c8",borderBottom:"1px solid #e0d9c8",position:"relative",cursor:"pointer"}} onClick={()=>{setFocusDate(new Date(d));openNew(d,hr);}}>
                        {evHere.map(ev=>{
                          const sm=t2m(ev.start),em=t2m(ev.end),dur=Math.max(em-sm,30);
                          const top=((sm%60)/60)*HH,height=Math.max((dur/60)*HH-3,18);
                          const c=cats[ev.cat]||{bg:"#eee",color:"#999",text:"#333"};
                          return (
                            <div key={ev.id} style={{position:"absolute",left:2,right:2,top,height,borderRadius:5,padding:"3px 5px",fontSize:".65rem",fontWeight:700,cursor:"pointer",zIndex:3,overflow:"hidden",background:c.bg,borderLeft:`3px solid ${c.color}`,color:c.text}} onClick={e=>{e.stopPropagation();openEdit(ev);}}>
                              <div style={{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{ev.title}</div>
                              {height>28&&<div style={{fontSize:".58rem",opacity:.65}}>{ev.start}</div>}
                            </div>
                          );
                        })}
                        {isToday(d)&&now.getHours()===hr&&(
                          <div style={{position:"absolute",left:0,right:0,top:`${(now.getMinutes()/60)*HH}px`,height:2,background:"#e8380d",zIndex:5,pointerEvents:"none"}}>
                            <div style={{position:"absolute",left:-1,top:-4,width:10,height:10,borderRadius:"50%",background:"#e8380d"}}></div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* MODALS */}
      {modal&&<BlockModal ev={modal.ev} date={modal.date||(modal.ev?new Date(modal.ev.date+"T00:00:00"):focusDate)} cats={cats} onSave={saveEvent} onDelete={deleteEvent} onClose={()=>setModal(null)} />}
      {catModal&&<CatModal cats={cats} onSave={saveCats} onClose={()=>setCatModal(false)} />}
      {nfcModal&&<NfcModal events={events} cats={cats} taskStates={taskStates} onClose={()=>setNfcModal(false)} />}
    </div>
  );
}
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AuthWrapper />);
  </script>
</body>
</html>

